// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum VisitStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum OrderStatus {
  OPEN
  CLOSED
}

enum OrderItemStatus {
  ORDERED
  VOIDED
}

enum ReviewVisibility {
  PUBLIC_ANONYMOUS
  PUBLIC_PROFILE
  RESTAURANT_ONLY
}

enum ConsentChannel {
  PUSH
  EMAIL
  WHATSAPP
}

enum ConsentStatus {
  OPT_IN
  OPT_OUT
}

model User {
  id        String   @id @default(uuid())
  name      String?
  email     String?  @unique
  createdAt DateTime @default(now())

  participants VisitParticipant[]
  claimedItems OrderItem[] @relation("ClaimedItems")
  reviews      Review[]
  notes        PrivateNote[]
  consents     Consent[]
}

model Restaurant {
  id           String   @id @default(uuid())
  name         String
  description  String?
  address      String?
  neighborhood String?
  cuisineType  String?
  priceLevel   Int      @default(2) // 1=$,2=$$,3=$$$
  openingHours String?  // json string por ahora
  createdAt    DateTime @default(now())

  tables   Table[]
  visits   Visit[]
  dishes   Dish[]
  reviews  Review[]
  notes    PrivateNote[]
  consents Consent[]
}

model Table {
  id           String  @id @default(uuid())
  restaurantId String
  label        String  // "10"
  qrToken      String  @unique
  isActive     Boolean @default(true)

  restaurant Restaurant @relation(fields: [restaurantId], references: [id])
  visits      Visit[]
}

model Visit {
  id           String      @id @default(uuid())
  restaurantId String
  tableId      String
  status       VisitStatus @default(OPEN)
  openedAt     DateTime    @default(now())
  closedAt     DateTime?

  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  table        Table      @relation(fields: [tableId], references: [id])
  participants VisitParticipant[]
  orders       Order[]
}

model VisitParticipant {
  visitId  String
  userId   String
  joinedAt DateTime @default(now())

  visit Visit @relation(fields: [visitId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@id([visitId, userId])
}

model Dish {
  id           String   @id @default(uuid())
  restaurantId String
  name         String
  description  String?
  category     String?
  currentPrice Decimal? 
  isActive     Boolean  @default(true)

  restaurant Restaurant @relation(fields: [restaurantId], references: [id])
  items      OrderItem[]
  reviews    Review[]
  notes      PrivateNote[]
}

model Order {
  id        String      @id @default(uuid())
  visitId   String
  status    OrderStatus @default(OPEN)
  createdAt DateTime    @default(now())

  visit Visit @relation(fields: [visitId], references: [id])
  items OrderItem[]
}

model OrderItem {
  id         String          @id @default(uuid())
  orderId    String
  dishId     String
  unitPrice  Decimal         
  notesStaff String?
  status     OrderItemStatus @default(ORDERED)

  // Claim/unclaim
  claimedByUserId String?
  claimedAt       DateTime?

  order Order @relation(fields: [orderId], references: [id])
  dish  Dish  @relation(fields: [dishId], references: [id])

  claimedBy User? @relation("ClaimedItems", fields: [claimedByUserId], references: [id])

  review Review?
}

model Review {
  id           String           @id @default(uuid())
  userId       String
  restaurantId String
  dishId       String
  orderItemId  String?          @unique
  rating       Int
  text         String?
  visibility   ReviewVisibility @default(PUBLIC_ANONYMOUS)
  createdAt    DateTime         @default(now())

  user       User       @relation(fields: [userId], references: [id])
  restaurant Restaurant @relation(fields: [restaurantId], references: [id])
  dish       Dish       @relation(fields: [dishId], references: [id])
  orderItem  OrderItem? @relation(fields: [orderItemId], references: [id])
}

model PrivateNote {
  id           String   @id @default(uuid())
  userId       String
  restaurantId String
  dishId       String
  tags         String[]
  notes        String?
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())

  user       User       @relation(fields: [userId], references: [id])
  restaurant Restaurant @relation(fields: [restaurantId], references: [id])
  dish       Dish       @relation(fields: [dishId], references: [id])

  @@unique([userId, restaurantId, dishId])
}

model Consent {
  id           String        @id @default(uuid())
  userId       String
  restaurantId String
  channel      ConsentChannel
  status       ConsentStatus @default(OPT_IN)
  updatedAt    DateTime      @updatedAt

  user       User       @relation(fields: [userId], references: [id])
  restaurant Restaurant @relation(fields: [restaurantId], references: [id])

  @@unique([userId, restaurantId, channel])
}

